<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileShare - Dashboard</title>
    <link rel="stylesheet" href="style/dstyle.css">
    <link rel="stylesheet" href="style/loader.css">
    <link rel="stylesheet" href="style/nav.css">
    <link rel="stylesheet" href="style/shared.css">
    <link rel="shortcut icon" href="./assests/favicon.ico" type="image/x-icon">
</head>

<body>
    <!-- Header -->
    <header>
        <nav class="navbar">
            <div id="logo-main">
                <a href="index.html"><img src="assests/mainlogo.png" alt="" style="width: 40px;"></a>
            </div>
            <div class="menu-toggle" onclick="hide()">&#9776;</div>
            <div class="logo" id="logo-mainn">FileShare</div>
            <ul class="nav-links">
                <li id="logo-in"><a href="index.html"><img src="assests/mainlogo.png" alt="" style="width: 40px;"></a>
                </li>
                <li class="logo" id="logo-in">FileShare</li>
                <li><a href="index.html">Home</a></li>
                <li><a href="upload.html">Upload</a></li>
                <li><a href="download.html">Download</a></li>
                <li style="display:none;"><a href="dashboard.html" id="dashboard-link">Dashboard</a></li>
                <li><a href="abus.html">About Us</a></li>
                <li><a href="login.html" class="login-btn" id="login-button">Login</a></li>
                <li style="display:none;"><a href="#" class="login-btn" id="logout-button" style="background:#ff1744;"
                        onclick="logout()">Logout</a></li>
            </ul>
        </nav>
    </header>

    <!-- Dashboard Section -->
    <section class="dashboard-section">
        <!-- Login Prompt (shown when not logged in) -->
        <div class="login-prompt" id="login-prompt" style="display:none;">
            <h1 style="color:#fff;">‚ö†Ô∏è Login Required</h1>
            <p style="color:#888;">You need to be logged in to view your dashboard.</p>
            <a href="login.html" class="login-btn" style="padding: 10px 30px; font-size: 1rem;">Login Now</a>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard-content" style="display:none;">
            <h1>üìä My Dashboard</h1>
            <p class="subtitle" id="welcome-msg">Welcome back!</p>

            <!-- Stats -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-value" id="stat-files">‚Äî</div>
                    <div class="stat-label">Total Files</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-downloads">‚Äî</div>
                    <div class="stat-label">Total Downloads</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-storage">‚Äî</div>
                    <div class="stat-label">Storage Used</div>
                </div>
            </div>

            <!-- File List -->
            <h2 style="color:#fff; margin-bottom:15px;">My Files</h2>
            <div class="files-list" id="files-list"></div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <p>&copy; 2024 FileShare. All rights reserved.</p>
    </footer>

    <script src="./script/nav.js"></script>
    <script src="./script/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (!isLoggedIn()) {
                document.getElementById('login-prompt').style.display = 'block';
                return;
            }

            document.getElementById('dashboard-content').style.display = 'block';
            document.getElementById('welcome-msg').textContent = `Welcome back, ${getUserName()}!`;
            loadFiles();
        });

        async function loadFiles() {
            try {
                const response = await authFetch('/api/my-files');
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        showToast('Session expired. Please login again.', 'warning');
                        localStorage.removeItem('token');
                        setTimeout(() => window.location.href = '/login.html', 1500);
                        return;
                    }
                    throw new Error('Failed to load files');
                }

                const files = await response.json();
                renderStats(files);
                renderFiles(files);
            } catch (err) {
                showToast('Error loading files', 'error');
            }
        }

        function renderStats(files) {
            document.getElementById('stat-files').textContent = files.length;
            const totalDownloads = files.reduce((sum, f) => sum + (f.download_count || 0), 0);
            document.getElementById('stat-downloads').textContent = totalDownloads;
            const totalSize = files.reduce((sum, f) => sum + parseInt(f.file_size || 0), 0);
            document.getElementById('stat-storage').textContent = formatFileSize(totalSize);
        }

        function renderFiles(files) {
            const list = document.getElementById('files-list');

            if (files.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <p>No files uploaded yet.</p>
                        <a href="upload.html" style="color:#007aff; text-decoration:none;">Upload your first file ‚Üí</a>
                    </div>`;
                return;
            }

            list.innerHTML = files.map(file => `
                <div class="file-card" id="file-${file.id}">
                    <div class="file-icon">${getFileIcon(file.file_name)}</div>
                    <div class="file-details">
                        <div class="fname">${file.file_name}</div>
                        <div class="fmeta">
                            ${formatFileSize(file.file_size)} ¬∑ ${file.download_count} downloads ¬∑ 
                            ${file.expires_at ? timeRemaining(file.expires_at) : 'No expiry'}
                            ${file.has_password ? ' ¬∑ üîí' : ''}
                        </div>
                    </div>
                    <div class="file-code" onclick="copyCode('${file.unique_code}')" title="Click to copy">${file.unique_code}</div>
                    <div class="file-actions">
                        <button class="delete-btn" onclick="deleteFile(${file.id})">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showToast('Code copied!', 'success');
            });
        }

        async function deleteFile(id) {
            if (!confirm('Are you sure you want to delete this file?')) return;

            try {
                const response = await authFetch(`/api/files/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    document.getElementById(`file-${id}`).remove();
                    showToast('File deleted', 'success');
                    loadFiles(); // Refresh stats
                } else {
                    const err = await response.json();
                    showToast(err.message || 'Delete failed', 'error');
                }
            } catch (err) {
                showToast('Error deleting file', 'error');
            }
        }
    </script>
</body>

</html>