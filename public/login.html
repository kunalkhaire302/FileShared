<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="shortcut icon" href="./assests/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="./style/loader.css">
    <link rel="stylesheet" href="./style/login.css">
    <link rel="stylesheet" href="./style/shared.css">
    <title>Login | FileShare</title>
</head>

<body>
    <div class="wrapper">
        <!-- Loading Spinner -->
        <div id="loading" style="display:none;" class="loading-container">
            <div class="spinner">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>
            <p style="color: white; margin: 30px;">Please wait...</p>
        </div>

        <div class="container" id="container">
            <div class="forms">
                <!-- Login Form -->
                <div class="form login">
                    <span class="title">Login</span>
                    <form method="post" action="/login">
                        <div class="input-field">
                            <input type="email" id="login-email" name="lemail" placeholder="Enter your email" required>
                            <i class="uil uil-envelope icon"></i>
                        </div>
                        <small id="login-email-error" class="error-message"></small>
                        <div class="input-field">
                            <input type="password" id="login-password" name="lpassword"
                                placeholder="Enter your password" required>
                            <i class="uil uil-lock icon"></i>
                            <i class="uil uil-eye-slash showHidePw" id="toggleLoginPassword"
                                onclick="togglePasswordVisibility('login-password','toggleLoginPassword')"></i>
                        </div>
                        <small id="login-password-error" class="error-message"></small>
                        <div class="checkbox-text">
                            <div class="checkbox-content">
                                <input type="checkbox" id="logCheck" name="remember">
                                <label for="logCheck" class="text">Remember me</label>
                            </div>
                        </div>
                        <div class="input-field button">
                            <input type="submit" value="Login">
                        </div>
                        <div class="loginError"></div>
                    </form>
                    <div class="login-signup">
                        <span class="text">Not a member?
                            <a href="#" class="text signup-link">Signup Now</a>
                        </span>
                    </div>
                </div>

                <!-- Registration Form -->
                <div class="form signup">
                    <span class="title">Registration</span>
                    <form method="post" action="/register">
                        <div class="input-field">
                            <input type="text" id="name" name="name" placeholder="Enter your name" required>
                            <i class="uil uil-user"></i>
                        </div>
                        <small id="name-error" class="error-message"></small>
                        <div class="input-field">
                            <input type="email" id="email" name="email" placeholder="Enter your email" required>
                            <i class="uil uil-envelope icon"></i>
                        </div>
                        <small id="email-error" class="error-message"></small>
                        <div class="input-field">
                            <input type="password" id="password" name="password" placeholder="Create a password"
                                required>
                            <i class="uil uil-lock icon"></i>
                            <i class="uil uil-eye-slash showHidePw" id="togglepassword"
                                onclick="togglePasswordVisibility('password','togglepassword')"></i>
                        </div>
                        <small id="password-error" class="error-message"></small>
                        <div class="input-field">
                            <input type="password" id="confirmPassword" name="confirmPassword"
                                placeholder="Confirm password" required>
                            <i class="uil uil-lock icon"></i>
                            <i class="uil uil-eye-slash showHidePw" id="toggleconfirmpassword"
                                onclick="togglePasswordVisibility('confirmPassword', 'toggleconfirmpassword')"></i>
                        </div>
                        <small id="confirmPassword-error" class="error-message"></small>
                        <div class="checkbox-text">
                            <div class="checkbox-content">
                                <input type="checkbox" id="termCon" required>
                                <label for="termCon" class="text">I accepted all terms and conditions</label>
                            </div>
                        </div>
                        <div class="input-field button">
                            <input type="submit" value="Signup" name="signup-submit">
                        </div>
                        <div class="registerError"></div>
                    </form>
                    <div class="login-signup">
                        <span class="text">Already a member?
                            <a href="#" class="text login-link">Login Now</a>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Loading spinner
        document.getElementById('loading').style.display = 'flex';
        window.addEventListener('load', function () {
            document.getElementById('loading').style.display = 'none';
        });

        // Password visibility toggle
        function togglePasswordVisibility(passwordId, iconId) {
            var passwordInput = document.getElementById(passwordId);
            var icon = document.getElementById(iconId);
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                icon.className = "uil uil-eye showHidePw";
            } else {
                passwordInput.type = "password";
                icon.className = "uil uil-eye-slash showHidePw";
            }
        }

        // Validation functions
        function validateField(id, errorId, validator) {
            const el = document.getElementById(id);
            const err = document.getElementById(errorId);
            el.addEventListener("input", () => { err.textContent = validator(el.value); });
        }

        validateField("login-email", "login-email-error", v => {
            if (!v) return "Email is required";
            if (!/^\S+@\S+\.\S+$/.test(v)) return "Invalid email format";
            return "";
        });
        validateField("login-password", "login-password-error", v => {
            if (v.length < 8 || v.length > 20 || !/\d/.test(v))
                return "Password must be 8-20 characters and include at least one number";
            return "";
        });
        validateField("name", "name-error", v => v.length < 3 ? "Name must be at least 3 characters" : "");
        validateField("email", "email-error", v => {
            if (!v) return "Email is required";
            if (!/^\S+@\S+\.\S+$/.test(v)) return "Invalid email format";
            return "";
        });
        validateField("password", "password-error", v => {
            if (v.length < 8 || v.length > 20 || !/\d/.test(v))
                return "Password must be 8-20 characters and include at least one number";
            return "";
        });
        document.getElementById("confirmPassword").addEventListener("input", function () {
            const err = document.getElementById("confirmPassword-error");
            err.textContent = this.value !== document.getElementById("password").value ? "Passwords do not match" : "";
        });

        // Login form submit
        document.querySelector(".form.login form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.querySelector("#login-email").value;
            const password = document.querySelector("#login-password").value;
            const remember = document.querySelector("#logCheck").checked;

            try {
                const response = await fetch('/login', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ lemail: email, lpassword: password, remember }),
                });
                const data = await response.json();
                const messageDiv = document.querySelector(".loginError");

                if (response.ok) {
                    messageDiv.innerHTML = `<p style="color: green;">${data.message}</p>`;
                    localStorage.setItem("token", data.token);
                    window.location.href = "/index.html";
                } else {
                    messageDiv.innerHTML = `<p style="color: red;">${data.message}</p>`;
                }
            } catch (error) {
                document.querySelector(".loginError").innerHTML = `<p style="color: red;">Something went wrong. Please try again.</p>`;
            }
        });

        // Registration form submit
        document.querySelector(".form.signup form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = document.querySelector("#name").value;
            const email = document.querySelector("#email").value;
            const password = document.querySelector("#password").value;
            const confirmPassword = document.querySelector("#confirmPassword").value;

            if (password !== confirmPassword) {
                document.querySelector(".registerError").innerHTML = `<p style="color: red;">Passwords do not match</p>`;
                return;
            }

            try {
                const response = await fetch("/register", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name, email, password }),
                });
                const data = await response.json();
                const messageDiv = document.querySelector(".registerError");

                if (response.ok) {
                    messageDiv.innerHTML = `<p style="color: green;">${data.message}</p>`;
                    setTimeout(() => window.location.href = "login.html", 1000);
                } else {
                    messageDiv.innerHTML = `<p style="color: red;">${data.message}</p>`;
                }
            } catch (error) {
                document.querySelector(".registerError").innerHTML = `<p style="color: red;">Something went wrong. Please try again.</p>`;
            }
        });
    </script>
    <script src="./script/login.js"></script>
</body>

</html>