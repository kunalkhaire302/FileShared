<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileShare - Upload</title>
    <link rel="stylesheet" href="style/ustyle.css">
    <link rel="stylesheet" href="style/loader.css">
    <link rel="stylesheet" href="style/nav.css">
    <link rel="stylesheet" href="style/shared.css">
    <link rel="shortcut icon" href="./assests/favicon.ico" type="image/x-icon">
</head>

<body>
    <!-- Header -->
    <header>
        <nav class="navbar">
            <div id="logo-main">
                <a href="index.html"><img src="assests/mainlogo.png" alt="" style="width: 40px;"></a>
            </div>
            <div class="menu-toggle" onclick="hide()">&#9776;</div>
            <div class="logo" id="logo-mainn">FileShare</div>
            <ul class="nav-links">
                <li id="logo-in"><a href="index.html"><img src="assests/mainlogo.png" alt="" style="width: 40px;"></a>
                </li>
                <li class="logo" id="logo-in">FileShare</li>
                <li><a href="index.html">Home</a></li>
                <li><a href="upload.html">Upload</a></li>
                <li><a href="download.html">Download</a></li>
                <li style="display:none;"><a href="dashboard.html" id="dashboard-link">Dashboard</a></li>
                <li><a href="abus.html">About Us</a></li>
                <li><a href="login.html" class="login-btn" id="login-button">Login</a></li>
                <li style="display:none;"><a href="#" class="login-btn" id="logout-button" onclick="logout()">Logout</a>
                </li>
            </ul>
        </nav>
    </header>

    <!-- Loading Spinner -->
    <div id="loading" style="display:none;" class="loading-container">
        <div class="spinner">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
        <p style="color: white; margin: 30px;">Uploading, please wait...</p>
    </div>

    <!-- Upload Section -->
    <section class="upload-section">
        <div class="container">
            <h1>Upload Your File</h1>

            <!-- Drag & Drop Zone -->
            <div class="drop-zone" id="drop-zone">
                <div class="drop-icon">üìÅ</div>
                <div class="drop-text">Drag & drop your file here, or <span id="browse-trigger">browse</span></div>
                <div class="file-preview" id="file-preview">
                    <span class="file-name" id="preview-name"></span><br>
                    <span class="file-size" id="preview-size"></span>
                </div>
            </div>

            <input type="file" name="file" id="file" required style="display:none;">

            <!-- File Options -->
            <div class="file-options" id="file-options" style="display:none;">
                <div class="option-row">
                    <label>üîí Password:</label>
                    <input type="password" id="file-password" placeholder="Optional">
                </div>
                <div class="option-row">
                    <label>‚è±Ô∏è Expires in:</label>
                    <select id="expiry-days">
                        <option value="1">1 day</option>
                        <option value="3">3 days</option>
                        <option value="7" selected>7 days</option>
                        <option value="14">14 days</option>
                        <option value="30">30 days</option>
                    </select>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container" id="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">0%</div>
            </div>

            <button type="button" id="upload-button" disabled>Upload</button>
        </div>
    </section>

    <!-- Upload Result Modal -->
    <div class="modal-overlay" id="upload-modal">
        <div class="modal">
            <h2>‚úÖ File Uploaded!</h2>
            <div class="code-display" id="modal-code"></div>
            <div class="qr-code" id="modal-qr"></div>
            <div class="file-info" id="modal-info"></div>
            <div class="btn-row">
                <button class="btn btn-primary" id="copy-code-btn">üìã Copy Code</button>
                <button class="btn btn-secondary"
                    onclick="document.getElementById('upload-modal').classList.remove('active')">Close</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>&copy; 2024 FileShare. All rights reserved.</p>
    </footer>

    <script src="./script/nav.js"></script>
    <script src="./script/common.js"></script>
    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file');
        const uploadButton = document.getElementById('upload-button');
        const browseTrigger = document.getElementById('browse-trigger');
        const filePreview = document.getElementById('file-preview');
        const previewName = document.getElementById('preview-name');
        const previewSize = document.getElementById('preview-size');
        const fileOptions = document.getElementById('file-options');
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');

        // Browse trigger
        browseTrigger.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('click', () => fileInput.click());

        // Drag & drop
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect(e.dataTransfer.files[0]);
            }
        });

        // File input change
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) handleFileSelect(fileInput.files[0]);
        });

        function handleFileSelect(file) {
            previewName.textContent = file.name;
            previewSize.textContent = formatFileSize(file.size);
            filePreview.classList.add('active');
            fileOptions.style.display = 'flex';
            uploadButton.disabled = false;

            if (file.size > 4 * 1024 * 1024) {
                showToast('File size exceeds 4MB limit', 'warning');
                uploadButton.disabled = true;
            }
        }

        // Upload with progress
        uploadButton.addEventListener('click', () => {
            if (!fileInput.files.length) return;

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('filePassword', document.getElementById('file-password').value);
            formData.append('expiryDays', document.getElementById('expiry-days').value);

            const xhr = new XMLHttpRequest();
            progressContainer.classList.add('active');
            uploadButton.disabled = true;

            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const pct = Math.round((e.loaded / e.total) * 100);
                    progressFill.style.width = pct + '%';
                    progressText.textContent = pct + '%';
                }
            });

            xhr.addEventListener('load', () => {
                progressContainer.classList.remove('active');
                uploadButton.disabled = false;

                if (xhr.status === 200) {
                    const result = JSON.parse(xhr.responseText);
                    showUploadResult(result);
                    showToast('File uploaded successfully!', 'success');
                    // Reset form
                    fileInput.value = '';
                    filePreview.classList.remove('active');
                    fileOptions.style.display = 'none';
                    uploadButton.disabled = true;
                    progressFill.style.width = '0%';
                } else {
                    try {
                        const err = JSON.parse(xhr.responseText);
                        showToast(err.message || 'Upload failed', 'error');
                    } catch (e) {
                        showToast('Upload failed', 'error');
                    }
                }
            });

            xhr.addEventListener('error', () => {
                progressContainer.classList.remove('active');
                uploadButton.disabled = false;
                showToast('Network error. Please try again.', 'error');
            });

            // Add auth header if logged in
            xhr.open('POST', '/upload');
            const token = getToken();
            if (token) xhr.setRequestHeader('Authorization', 'Bearer ' + token);
            xhr.send(formData);
        });

        function showUploadResult(result) {
            const modal = document.getElementById('upload-modal');
            document.getElementById('modal-code').textContent = result.uniqueCode;

            // QR code using public API
            const downloadUrl = window.location.origin + '/download.html?code=' + result.uniqueCode;
            document.getElementById('modal-qr').innerHTML =
                `<img src="https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(downloadUrl)}&size=150x150&bgcolor=ffffff" alt="QR Code" width="150" height="150">`;

            const info = [];
            info.push(`üìÑ ${result.fileName} (${formatFileSize(result.fileSize)})`);
            if (result.expiresAt) info.push(`‚è±Ô∏è Expires: ${formatDate(result.expiresAt)}`);
            if (result.hasPassword) info.push('üîí Password protected');
            document.getElementById('modal-info').innerHTML = info.join('<br>');

            // Copy button
            document.getElementById('copy-code-btn').onclick = () => {
                navigator.clipboard.writeText(result.uniqueCode).then(() => {
                    showToast('Code copied to clipboard!', 'success');
                });
            };

            modal.classList.add('active');
        }
    </script>
</body>

</html>